Bridge.assembly("DlhSoft.UndoManagementLibrary",function(){"use strict";Bridge.define("DlhSoft.UndoManagementLibrary.UndoStack",{inherits:[System.ComponentModel.INotifyPropertyChanged],completedActions:null,undoneActions:null,config:{events:{PropertyChanged:null},alias:["addPropertyChanged","System$ComponentModel$INotifyPropertyChanged$addPropertyChanged","removePropertyChanged","System$ComponentModel$INotifyPropertyChanged$removePropertyChanged"],init:function(){this.completedActions=new(System.Collections.Generic.List$1(DlhSoft.UndoManagementLibrary.UndoStack.ActionRecord));this.undoneActions=new(System.Collections.Generic.List$1(DlhSoft.UndoManagementLibrary.UndoStack.ActionRecord))}},getCanUndo:function(){return System.Linq.Enumerable.from(this.completedActions).any()},getCanRedo:function(){return System.Linq.Enumerable.from(this.undoneActions).any()},record:function(whatWasDone,howToUndo,whenWasDone){var $t,originallyCanUndo,originallyCanRedo;if(whenWasDone===void 0&&(whenWasDone=null),originallyCanUndo=this.getCanUndo(),originallyCanRedo=this.getCanRedo(),this.undoneActions.clear(),this.completedActions.insert(0,Bridge.merge(new DlhSoft.UndoManagementLibrary.UndoStack.ActionRecord,{whatWasDone:whatWasDone,howToUndo:howToUndo,whenWasDone:($t=whenWasDone,$t!=null?$t:new Date)})),!originallyCanUndo)this.onPropertyChanged("canUndo");if(originallyCanRedo)this.onPropertyChanged("canRedo")},doAndRecord:function(whatToDo,howToUndo){var now=new Date;whatToDo();this.record(whatToDo,howToUndo,now)},undo:function(relatedActionSpan){var originallyCanRedo,lastCompletedAction,previouslyCompletedAction;if(relatedActionSpan===void 0&&(relatedActionSpan=null),this.getCanUndo()){for(System.TimeSpan.eq(relatedActionSpan,null)&&(relatedActionSpan=System.TimeSpan.zero),originallyCanRedo=this.getCanRedo();;)if(lastCompletedAction=System.Linq.Enumerable.from(this.completedActions).first(),this.completedActions.removeAt(0),lastCompletedAction.howToUndo(),this.undoneActions.insert(0,lastCompletedAction),previouslyCompletedAction=System.Linq.Enumerable.from(this.completedActions).firstOrDefault(null,null),previouslyCompletedAction==null||System.TimeSpan.gt(Bridge.Date.subdd(lastCompletedAction.whenWasDone,previouslyCompletedAction.whenWasDone),relatedActionSpan))break;if(!this.getCanUndo())this.onPropertyChanged("canUndo");if(!originallyCanRedo)this.onPropertyChanged("canRedo")}},redo:function(relatedActionSpan){var originallyCanUndo,lastUndoneAction,previouslyUndoneAction;if(relatedActionSpan===void 0&&(relatedActionSpan=null),this.getCanRedo()){for(System.TimeSpan.eq(relatedActionSpan,null)&&(relatedActionSpan=System.TimeSpan.zero),originallyCanUndo=this.getCanUndo();;)if(lastUndoneAction=System.Linq.Enumerable.from(this.undoneActions).first(),this.undoneActions.removeAt(0),lastUndoneAction.whatWasDone(),this.completedActions.insert(0,lastUndoneAction),previouslyUndoneAction=System.Linq.Enumerable.from(this.undoneActions).firstOrDefault(null,null),previouslyUndoneAction==null||System.TimeSpan.gt(Bridge.Date.subdd(previouslyUndoneAction.whenWasDone,lastUndoneAction.whenWasDone),relatedActionSpan))break;if(!this.getCanRedo())this.onPropertyChanged("canRedo");if(!originallyCanUndo)this.onPropertyChanged("canUndo")}},onPropertyChanged:function(propertyName){Bridge.staticEquals(this.PropertyChanged,null)?null:this.PropertyChanged(this,new System.ComponentModel.PropertyChangedEventArgs(propertyName))}});Bridge.define("DlhSoft.UndoManagementLibrary.UndoStack.ActionRecord",{whatWasDone:null,howToUndo:null,config:{init:function(){this.whenWasDone=new Date(-864e13)}}})});